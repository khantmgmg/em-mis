<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="./js/auth.js"></script>
    <base target="_top" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Patient data</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
  </head>

  <body>
    <div class="container">
      <h1 class="mb-4">View Data from MIS</h1>
      <form id="misForm">
        <div class="row">
          <div class="col-5 form-group my-2 py-2">
            <label>Data entry date (Start):</label>
            <input
              type="date"
              class="form-control"
              name="sdate"
              id="sdate"
              value="2024-01-01"
              required
            />
          </div>
          <div class="col-5 form-group my-2 py-2">
            <label>Data entry date (End):</label>
            <input
              type="date"
              class="form-control"
              name="edate"
              id="edate"
              value="2024-02-07"
              required
            />
          </div>
          <div class="col-2 form-group my-2 py-2">
            <label>Click to get data</label>
            <button
              type="button"
              class="btn btn-primary form-control"
              onclick="execute()"
            >
              Get Data
            </button>
          </div>
        </div>
      </form>
      <hr />
      <div id="data"></div>
      <div id="ptData-head">
        <div class="row">
          <div class="col-1"><strong>No.</strong></div>
          <div class="col-1"><strong>Date</strong></div>
          <div class="col-2"><strong>Name</strong></div>
          <div class="col-1"><strong>Age</strong></div>
          <div class="col-2"><strong>Address</strong></div>
          <div class="col-1"><strong>Sex</strong></div>
          <div class="col-1"><strong>Pregnancy status</strong></div>
          <div class="col-1"><strong>Test result</strong></div>
        </div>
      </div>
      <div id="ptData"></div>
    </div>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
  </body>
  <script src="./js/functions.js"></script>
  <script>
    // execute();
    function sortJson(obj) {
      return Object.keys(obj)
        .sort()
        .reduce((accumulator, currentValue) => {
          accumulator[currentValue] = obj[currentValue];
          return accumulator;
        }, {});
    }

    async function execute() {
      const sdate = document.getElementById("sdate").value;
      const edate = document.getElementById("edate").value;
      // const rpMth = document.getElementById("rpMth").value;
      const domain = localStorage.getItem("domain");
      const token = localStorage.getItem("token");
      const headers = generateHeaders(token);
      const url = `${domain}/api/tracker/trackedEntities.json?enrollmentEnrolledAfter=${sdate}&enrollmentEnrolledBefore=${edate}&program=qDkgAbB5Jlk&orgUnit=kqBYGU7QcPk&ouMode=DESCENDANTS&fields=trackedEntity,enrollments[enrollment,attributes[attribute,displayName,value],events[event,status,orgUnit,orgUnitName,occurredAt,dataValues[dataElement,value]]]&totalPages=true&pageSize=100`;
      let cnt = true;
      let ptData = [];
      let page = 1;
      while (cnt) {
        let teiUrl = `${url}&page=${page}`;
        console.log(teiUrl);
        teis = await makeGetRequest(teiUrl, headers);
        if (teis["instances"].length > 0) {
          ptData = ptData.concat(teis["instances"]);
          page = page + 1;
        } else {
          cnt = false;
        }
      }
      console.log(ptData);
      finaldata = {};
      ptData.forEach((tei) => {
        let trackedEntity = tei["trackedEntity"];
        let enrollments = tei["enrollments"];
        enrollments.forEach((enrollment) => {
          let enrollmentId = enrollment["enrollment"];
          let events = enrollment["events"];
          events.forEach((event) => {
            event["enrollment"] = enrollmentId;
            event["trackedEntity"] = trackedEntity;
            event["attributes"] = enrollment["attributes"];
            let eventId = event["event"];
            let occurredAt = event["occurredAt"];
            let reportingMonth = occurredAt.substring(0, 7);
            if (!(reportingMonth in finaldata)) {
              finaldata[reportingMonth] = {};
            }
            let dataValues = event["dataValues"];

            let persnCode = "";
            let cblMth = "";
            let cblYr = "";
            let cblPage = "";

            for (let i = 0; i < dataValues.length; i++) {
              let dataValue = dataValues[i];
              if (dataValue["dataElement"] == "AS3g1pCXG7z") {
                personCode = dataValue["value"];
              } else if (dataValue["dataElement"] == "n3Bkq0yjIa7") {
                cblMth = dataValue["value"];
              } else if (dataValue["dataElement"] == "mHmqOLqzXB2") {
                cblYr = dataValue["value"];
              } else if (dataValue["dataElement"] == "m7sW6eVhXqz") {
                cblPage = dataValue["value"];
              }
            }
            let cblPeriod = `${cblMth}-${cblYr}`;
            // console.log(`${personCode} - ${cblPeriod} - ${cblPage}`);
            if (!(personCode in finaldata[reportingMonth])) {
              finaldata[reportingMonth][personCode] = {};
            }
            // console.log(Object.keys(finaldata[reportingMonth]));
            if (!(cblPeriod in finaldata[reportingMonth][personCode])) {
              finaldata[reportingMonth][personCode][cblPeriod] = {};
            }
            // console.log(Object.keys(finaldata[reportingMonth][personCode]));
            if (
              !(cblPage in finaldata[reportingMonth][personCode][cblPeriod])
            ) {
              finaldata[reportingMonth][personCode][cblPeriod][cblPage] = [];
            }
            // console.log(Object.keys(finaldata[reportingMonth][personCode][cblPeriod]));
            // console.log(finaldata[reportingMonth][personCode][cblPeriod][cblPage]);
            finaldata[reportingMonth][personCode][cblPeriod][cblPage].push(
              event
            );
          });
        });
      });

      finaldata = sortJson(finaldata);
      Object.keys(finaldata).forEach((mth) => {
        finaldata[mth] = sortJson(finaldata[mth]);
      });
      // console.log(finaldata);
      let htmlData = document.getElementById("data");

      let formDiv = document.createElement("form");
      let mainRowDiv = document.createElement("div");
      mainRowDiv.className = "row";

      let rpMthCol = createSelectBox(
        "rpMth",
        "Reporting period",
        "rpMthChange();"
      );
      let personCodeCol = createSelectBox(
        "personCode",
        "Person code",
        "personCodeChange();"
      );
      let cblPeriodCol = createSelectBox(
        "cblPeriod",
        "Carbonless period",
        "cblPeriodChange();"
      );
      let cblPageCol = createSelectBox(
        "cblPage",
        "Carbonless page number",
        "cblPageChange();"
      );

      mainRowDiv.appendChild(rpMthCol);
      mainRowDiv.appendChild(personCodeCol);
      mainRowDiv.appendChild(cblPeriodCol);
      mainRowDiv.appendChild(cblPageCol);
      formDiv.appendChild(mainRowDiv);
      htmlData.appendChild(formDiv);

      let rpMthSelect = document.getElementById("rpMth");
      let rpMths = Object.keys(finaldata);
      rpMths.forEach((rpMth) => {
        let rpMthOption = document.createElement("option");
        rpMthOption.value = rpMth;
        rpMthOption.innerText = rpMth;
        rpMthSelect.appendChild(rpMthOption);
      });

      // document.getElementById("rpMth").onchange = "rpMthChange();";
      // document.getElementById("personCode").onchange = "personCodeChange();";
      // document.getElementById("cblPeriod").onchange = "cblPeriodChange();";
    }

    function rpMthChange() {
      let rpMth = document.getElementById("rpMth").value;
      let personCodeSelect = document.getElementById("personCode");
      let cblPeriodSelect = document.getElementById("cblPeriod");
      let cblPageSelect = document.getElementById("cblPage");
      personCodeSelect.innerHTML = "";
      cblPeriodSelect.innerHTML = "";
      cblPageSelect.innerHTML = "";
      let personCodes = Object.keys(finaldata[rpMth]);
      personCodes.forEach((personCode) => {
        let personCodeOption = document.createElement("option");
        personCodeOption.value = personCode;
        personCodeOption.innerText = personCode;
        personCodeSelect.appendChild(personCodeOption);
      });
    }

    function personCodeChange() {
      let rpMth = document.getElementById("rpMth").value;
      let personCode = document.getElementById("personCode").value;
      let cblPeriodSelect = document.getElementById("cblPeriod");
      let cblPageSelect = document.getElementById("cblPage");
      cblPeriodSelect.innerHTML = "";
      cblPageSelect.innerHTML = "";
      let cblPeriods = Object.keys(finaldata[rpMth][personCode]);
      cblPeriods.forEach((cblPeriod) => {
        let cblPeriodOption = document.createElement("option");
        cblPeriodOption.value = cblPeriod;
        cblPeriodOption.innerText = cblPeriod;
        cblPeriodSelect.appendChild(cblPeriodOption);
      });
    }

    function cblPeriodChange() {
      let rpMth = document.getElementById("rpMth").value;
      let personCode = document.getElementById("personCode").value;
      let cblPeriod = document.getElementById("cblPeriod").value;
      let cblPageSelect = document.getElementById("cblPage");
      cblPageSelect.innerHTML = "";
      let cblPages = Object.keys(finaldata[rpMth][personCode][cblPeriod]);
      cblPages.forEach((cblPage) => {
        let cblPageOptions = document.createElement("option");
        cblPageOptions.value = cblPage;
        cblPageOptions.innerText = cblPage;
        cblPageSelect.appendChild(cblPageOptions);
      });
    }

    function cblPageChange() {
      let ptData = document.getElementById("ptData");
      ptData.innerHTML = "";
      let rpMth = document.getElementById("rpMth").value;
      let personCode = document.getElementById("personCode").value;
      let cblPeriod = document.getElementById("cblPeriod").value;
      let cblPage = document.getElementById("cblPage").value;
      let jsonData = finaldata[rpMth][personCode][cblPeriod][cblPage];

      let srno = "";
      let testDate = "";
      let ptName = "";
      let ptAge = "";
      let ptAddress = "";
      let ptSex = "";
      let ptPreg = "";
      let testResult = "";
      let permanentAddr = "";
      jsonData.forEach((idata) => {
        console.log(idata);
        let attributes = idata["attributes"];
        let dataValues = idata["dataValues"];
        let orgUnitName = idata["orgUnitName"];

        attributes.forEach((attribute) => {
          switch (attribute["attribute"]) {
            case "PFpmOsgBCif":
              ptName = attribute["value"];
            case "oindugucx72":
              ptSex = attribute["value"];
            case "XN0145qZ7kH":
              permanentAddr = attribute["value"];
          }
        });
        dataValues.forEach((dataValue) => {
          switch (dataValue["dataElement"]) {
            case "pgULUzbdazk":
              srno = dataValue["value"];
            case "GMiQykxracx":
              testDate = dataValue["value"];
            case "ECVGASvuHV3":
              ptAge = dataValue["value"];
            case "LMdJwJW68yO":
              ptPreg = dataValue["value"];
            case "vGxpKVMkmaW":
              testResult = dataValue["value"];
          }
        });
        if (orgUnitName.includes("side township")) {
          ptAddress = `${permanentAddr} (${orgUnitName})`;
        }
        let ptRowDiv = createPatientRowDiv(
          srno,
          testDate,
          ptName,
          ptAge,
          ptAddress,
          ptSex,
          ptPreg,
          testResult
        );
        ptData.appendChild(ptRowDiv);
      });
    }

    function createPatientRowDiv(
      srno,
      testDate,
      ptName,
      ptAge,
      ptAddress,
      ptSex,
      ptPreg,
      testResult
    ) {
      let ptRowDiv = document.createElement("div");
      ptRowDiv.className = "row";
      let colSrno = createPatientDataCellDiv(srno, 1);
      let colTestDate = createPatientDataCellDiv(testDate, 1);
      let colPtName = createPatientDataCellDiv(ptName, 2);
      let colPtAge = createPatientDataCellDiv(ptAge, 1);
      let colPtAddress = createPatientDataCellDiv(ptAddress, 2);
      let colPtSex = createPatientDataCellDiv(ptSex, 1);
      let colPtPreg = createPatientDataCellDiv(ptPreg, 1);
      let colTestResult = createPatientDataCellDiv(testResult, 1);
      ptRowDiv.appendChild(colSrno);
      ptRowDiv.appendChild(colTestDate);
      ptRowDiv.appendChild(colPtName);
      ptRowDiv.appendChild(colPtAge);
      ptRowDiv.appendChild(colPtAddress);
      ptRowDiv.appendChild(colPtSex);
      ptRowDiv.appendChild(colPtPreg);
      ptRowDiv.appendChild(colTestResult);
      return ptRowDiv;
    }

    function createPatientDataCellDiv(info, colWidth) {
      let ptDataCellDiv = document.createElement("div");
      ptDataCellDiv.className = `col-${colWidth}`;
      ptDataCellDiv.innerTest = info;
      return ptDataCellDiv;
    }

    function createSelectBox(id, labelText, jsFunction) {
      let col = document.createElement("div");
      col.className = "col-3";
      let label = document.createElement("label");
      label.for = id;
      label.id = `label_${id}`;
      label.className = "row form-label";
      label.innerText = labelText;
      let select = document.createElement("select");
      select.id = id;
      select.size = 10;
      select.className = "row form-select";
      select.setAttribute("onChange", jsFunction);
      col.appendChild(label);
      col.appendChild(select);
      return col;
    }

    function createTreeElement(key, value, vType) {
      const div = document.createElement("div");
      if (vType === "object") {
        const li = document.createElement("li");
        li.textContent = key;
        const childTree = createTree(value);
        childTree.classList.add("hidden");
        li.appendChild(childTree);
        li.addEventListener("click", function (event) {
          event.stopPropagation();
          const children = this.querySelector("ul");
          if (children) {
            children.classList.toggle("hidden");
          }
        });
        div.appendChild(li);
      } else if (vType === "array") {
        let ptName = "";
        let ptAge = "";
        let ptSex = "";
        let testResult = "";
        value.forEach((val) => {
          let attr = val["attributes"];
          let dVal = val["dataValues"];
          attr.forEach((attribute) => {
            if (attribute["attribute"] == "PFpmOsgBCif") {
              ptName = attribute["value"];
            } else if (attribute["attribute"] == "oindugucx72") {
              ptSex = attribute["value"];
            }
          });

          dVal.forEach((dataValue) => {
            if (dataValue["dataElement"] == "ECVGASvuHV3") {
              ptAge = dataValue["value"];
            } else if (dataValue["dataElement"] == "vGxpKVMkmaW") {
              testResult = dataValue["value"];
            }
          });
          let text = `${ptName}, ${ptAge}, ${ptSex}, ${testResult}`;
          let ptLi = document.createElement("li");
          ptLi.innerText = text;
          div.appendChild(ptLi);
        });
      }
      return div;
    }

    function createTree(json) {
      const ul = document.createElement("ul");

      for (const key in json) {
        if (json.hasOwnProperty(key)) {
          const valueType = checkValueType(json[key]);
          const li = createTreeElement(key, json[key], valueType);
          for (let x = 0; x < li.children.length; x++) {
            ul.appendChild(li.children[x]);
          }
        }
      }

      return ul;
    }

    function checkValueType(value) {
      if (typeof value === "object") {
        if (Array.isArray(value)) {
          return "array";
        } else if (value !== null) {
          return "object";
        }
      }
      return "other";
    }
  </script>
</html>
