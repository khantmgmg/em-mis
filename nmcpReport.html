<!DOCTYPE html>
<html lang="en">
	<head>
		<script src="./js/auth.js"></script>
		<base target="_top" />
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Patient data</title>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
			rel="stylesheet"
			integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
			crossorigin="anonymous"
		/>
	</head>

	<body>
		<div style="margin-left: 12vw; margin-right: 3vw">
			<h1 class="mb-1">View Data from MIS</h1>
			<hr class="m-1" />
			<form id="misForm">
				<div class="row">
					<div class="col-5 form-group">
						<label>Select township</label>
						<select id="slttsp"><option value="" selected></option></select>
						<sele type="date" class="form-control" name="sdate" id="sdate" value="2024-01-01" required />
					</div>
					<div class="col-5 form-group">
						<label>Data entry date (Start):</label>
						<input type="date" class="form-control" name="sdate" id="sdate" value="2024-01-01" required />
					</div>
					<div class="col-5 form-group">
						<label>Data entry date (End):</label>
						<input type="date" class="form-control" name="edate" id="edate" value="2024-01-10" required />
					</div>
					<div class="col-2 form-group">
						<label>Click to get data</label>
						<button type="button" class="btn btn-primary form-control" onclick="callFromModule('execute');">Get Data</button>
					</div>
				</div>
			</form>
			<hr class="m-1" />
			<div id="data" class="row"></div>
			<hr class="m-1" />
			<button onclick="exportTableToExcel('nmcpreport', 'NMCP report')">Export to Excel</button>
			<table class="table table-bordered" style="font-size:0.5em;" id="nmcpreport">
				<thead id="reportheading">
					<!-- <tr class="text-center">
						<th class="align-middle" rowspan="3">Sr</th>
						<th class="align-middle" rowspan="3">State/Region</th>
						<th class="align-middle" rowspan="3">Township</th>
						<th class="align-middle" rowspan="3">RHC</th>
						<th class="align-middle" rowspan="3">Subcenter</th>
						<th class="align-middle" rowspan="3">Village</th>
						<th class="align-middle" rowspan="3">Provider code</th>
						<th class="align-middle" rowspan="3">Age group</th>
						<th class="align-middle" colspan="10">RDT</th>
						<th class="align-middle" colspan="4">RDT + Microscopy</th>
					</tr>
					<tr class="text-center">
						<th class="align-middle" colspan="2">Total exam</th>
						<th class="align-middle" colspan="2">Pf</th>
						<th class="align-middle" colspan="2">Pv/Non-Pf</th>
						<th class="align-middle" colspan="2">Mix</th>
						<th class="align-middle" colspan="2">Total positive</th>
						<th class="align-middle" colspan="2">Grand Total Exam</th>
						<th class="align-middle" colspan="2">Grand Total Positive</th>
					</tr>
					<tr class="text-center">
						<th>Male</th>
						<th>Female</th>
						<th>Male</th>
						<th>Female</th>
						<th>Male</th>
						<th>Female</th>
						<th>Male</th>
						<th>Female</th>
						<th>Male</th>
						<th>Female</th>
						<th>Male</th>
						<th>Female</th>
						<th>Male</th>
						<th>Female</th>
					</tr> -->
				</thead>
				<tbody id="reportdata"></tbody>
			</table>
		</div>
		<script
			src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
			integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
			crossorigin="anonymous"
		></script>
	</body>
	<script>
		callFromModule('populateTsp');
		function callFromModule(functionName) {
			import("./js/nmcpIngoReport.js")
				.then((module) => {
					if (module[functionName]) {
						module[functionName]();
					} else {
						console.error(`Function ${functionName} not found in module`);
					}
				})
				.catch((error) => {
					console.error("Error importing module:", error);
				});
		}
	</script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

	<script>
		function exportTableToExcel(tableID, filename = '') {
		// Get the HTML table
		var table = document.getElementById(tableID);

		// Convert the HTML table to a workbook
		var wb = XLSX.utils.table_to_book(table, { sheet: "Sheet1" });

		// Generate a binary string from the workbook
		var wbout = XLSX.write(wb, {
			bookType: 'xlsx',
			type: 'binary'
		});

		// Function to convert a binary string to an array buffer
		function s2ab(s) {
			var buf = new ArrayBuffer(s.length);
			var view = new Uint8Array(buf);
			for (var i = 0; i < s.length; i++) {
				view[i] = s.charCodeAt(i) & 0xFF;
			}
			return buf;
		}

		// Save the generated Excel file
		saveAs(new Blob([s2ab(wbout)], { type: "application/octet-stream" }), filename + '.xlsx');
	}

	</script>
</html>
